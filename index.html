<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://api.github.com; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=(), clipboard-read=(self), clipboard-write=(self)">
  <title>AlienPass</title>
  <link rel="icon" href="./alienpass.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="./alienpass.svg" type="image/svg+xml">
  <link rel="mask-icon" href="./alienpass.svg" color="#3b82f6">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./alienpass.svg">
  <meta name="theme-color" content="#3b82f6" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b0b0c" media="(prefers-color-scheme: dark)">
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --input-bg: #ffffff;
      --input-border: #cccccc;
      --btn-bg: #f2f2f2;
      --btn-fg: #111111;
      --btn-border: #cccccc;
      --accent: #3b82f6;
      --error: #b91c1c;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0b0c;
        --fg: #e6e6e6;
        --muted: #a0a0a0;
        --input-bg: #141417;
        --input-border: #2a2a2e;
        --btn-bg: #1f1f23;
        --btn-fg: #e6e6e6;
        --btn-border: #2a2a2e;
        --accent: #60a5fa;
        --error: #f87171;
      }
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    header {
      margin: 8px 0 16px;
    }
    h1 {
      font-size: 1.25rem;
      margin: 0 0 4px;
    }
    p.desc {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .credit-quote {
      margin: 0;
      padding-left: 12px;
      border-left: 3px solid var(--input-border);
      color: var(--muted);
    }
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 8px; }
    .brand .logo { width: 56px; height: 56px; display: block; }
    .header-actions .right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Domains editor */
    .domain-row { display: flex; align-items: center; gap: 8px; }
    .domain-row input[type="text"] { flex: 1; }
    .domain-row button.small { white-space: nowrap; }
    form {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .field {
      display: flex;
      flex-direction: column;
    }
    input[type="text"], input[type="password"] {
      appearance: none;
      background: var(--input-bg);
      color: var(--fg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1rem;
      outline: none;
    }
    select {
      appearance: none;
      background: var(--input-bg);
      color: var(--fg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1rem;
      outline: none;
    }
    input[type="text"][readonly] {
      opacity: 0.95;
    }
    input[type="text"]:focus, input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent);
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-label {
      margin: 0;
      font-weight: 500;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }
    button, input[type="button"], input[type="reset"] {
      appearance: none;
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--btn-border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.primary, input.primary[type="button"] {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
    }
    .error {
      color: var(--error);
      font-size: 0.9rem;
      min-height: 1.2em;
    }
    footer {
      margin-top: 28px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 12px 0 8px;
      border-bottom: 1px solid var(--input-border);
    }
    .tab {
      appearance: none;
      background: transparent;
      color: var(--fg);
      border: none;
      border-bottom: 2px solid transparent;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }
    [hidden] { display: none !important; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: color-mix(in srgb, var(--bg) 40%, #000 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }
    .modal {
      background: var(--bg);
      color: var(--fg);
      border: 1px solid var(--input-border);
      border-radius: 10px;
      max-width: 560px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .modal header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--input-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0;
    }
    .modal .content {
      padding: 8px 16px 16px;
      overflow: auto;
    }
    .modal .actions {
      padding: 10px 16px;
      border-top: 1px solid var(--input-border);
      display: flex;
      justify-content: flex-end;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
    }
    .list-item .meta {
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .tag {
      display: inline-block;
      border: 1px solid var(--btn-border);
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .star { color: #eab308; }
    .ghost { opacity: 0.7; }
    .inline-actions { display: flex; gap: 6px; }
    .small { font-size: 0.85rem; padding: 6px 10px; }

    /* Utilities */
    .left { justify-content: flex-start; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
  .mb-8 { margin-bottom: 8px; }
  .mb-12 { margin-bottom: 12px; }

    textarea {
      resize: vertical;
      background: var(--input-bg);
      color: var(--fg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 1rem;
      outline: none;
    }
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-actions">
        <div class="brand">
          <img src="./alienpass.svg" alt="AlienPass logo" class="logo" width="56" height="56">
          <div>
            <h1>AlienPass</h1>
            <p class="desc">Generate a site password from your master password, login, and a suffix.</p>
          </div>
        </div>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <button id="tab-generate-tab" class="tab active" data-tab="generate" role="tab" aria-selected="true" aria-controls="tab-generate">Generate</button>
      <button id="tab-vault-tab" class="tab" data-tab="vault" role="tab" aria-selected="false" aria-controls="tab-vault">Vault</button>
  <button id="tab-settings-tab" class="tab" data-tab="settings" role="tab" aria-selected="false" aria-controls="tab-settings">Settings</button>
  <button id="tab-download-tab" class="tab" data-tab="download" role="tab" aria-selected="false" aria-controls="tab-download">Download</button>
  <button id="tab-about-tab" class="tab" data-tab="about" role="tab" aria-selected="false" aria-controls="tab-about">About</button>
    </div>

    <section id="tab-generate" role="tabpanel" aria-labelledby="tab-generate-tab">
  <form id="alienPassForm" novalidate autocomplete="off">
  <div class="field">
    <label for="mpass">Master password</label>
  <input type="password" id="mpass" name="mpass" autocomplete="off" spellcheck="false" autocorrect="off" inputmode="text" readonly>
  </div>

      <div class="field">
        <div class="row">
          <input type="checkbox" id="newPas" name="newPas">
          <label for="newPas" class="checkbox-label">New password?</label>
        </div>
      </div>

      <div class="field" id="confirmField" hidden>
        <label for="confirmPass">Confirm password</label>
  <input type="password" id="confirmPass" name="confirmPass" disabled autocomplete="off" spellcheck="false" autocorrect="off" inputmode="text">
      </div>

      <div class="field" id="saveLoginField" hidden>
        <div class="row">
          <input type="checkbox" id="saveLogin" name="saveLogin" checked>
          <label for="saveLogin" class="checkbox-label">Save login?</label>
        </div>
      </div>

      <div class="field">
        <label for="login">Login</label>
        <input type="text" id="login" name="login" autocomplete="username" spellcheck="false" autocorrect="off">
      </div>

      <div class="field">
        <label for="added">Added</label>
  <input type="text" id="added" name="added" autocomplete="off" spellcheck="false" autocorrect="off" placeholder="e.g. *ABC">
      </div>

      <div class="field">
        <label for="algorithm">Algorithm</label>
        <select id="algorithm" name="algorithm">
          <option value="xxh32">xxHash32</option>
          <option value="md5m120">MD5 Modified 120-bit</option>
          <option value="sha256_96">SHA-256/96</option>
        </select>
      </div>

      <div class="field">
        <label for="out">Generated password</label>
        <input type="text" id="out" name="out" readonly>
        <div id="error" class="error"></div>
      </div>

      <div class="actions">
        <input type="button" id="generateBtn" class="primary" value="Generate">
        <input type="button" id="copyBtn" value="Copy">
        <input type="reset" id="clearBtn" value="Clear">
        <input type="button" id="openVaultBtn" class="ghost" value="Vault">
      </div>
    </form>
    </section>

    <section id="tab-vault" role="tabpanel" aria-labelledby="tab-vault-tab" hidden>
      <div class="actions left mt-8 mb-12">
        <button id="addEntryBtn" class="primary small" type="button">Add</button>
        <button id="backupBtn" class="small" type="button">Backup</button>
        <button id="restoreBtn" class="small" type="button">Restore</button>
        <input type="file" id="restoreFileInput" accept="application/json" hidden>
      </div>
      <div class="field">
        <input type="text" id="vaultSearch" placeholder="Search name, login, suffix, domains, note">
      </div>
      <div id="vaultListFull" class="list mt-12"></div>
      <div id="vaultEmpty" class="ghost mt-12" hidden>No entries yet. Click Add to create one.</div>
    </section>

    <section id="tab-settings" role="tabpanel" aria-labelledby="tab-settings-tab" hidden>
      <div class="field mt-12">
        <label for="defaultSuffix">Default suffix</label>
  <input type="text" id="defaultSuffix" autocomplete="off" spellcheck="false" autocorrect="off" placeholder="e.g. *ABC">
        <div class="ghost mt-8">This suffix will auto-fill the Added field on the Generate tab if it's empty.</div>
      </div>
      <div class="field mt-12">
        <label for="defaultAlgorithm">Default algorithm</label>
        <select id="defaultAlgorithm">
          <option value="xxh32">xxHash32</option>
          <option value="md5m120">MD5 Modified 120-bit</option>
          <option value="sha256_96">SHA-256/96</option>
        </select>
        <div class="ghost mt-8">This will preselect the algorithm on the Generate tab.</div>
      </div>
      <div class="actions left mt-12">
        <button id="saveSettingsBtn" class="primary" type="button">Save settings</button>
      </div>
    </section>

    <section id="tab-download" role="tabpanel" aria-labelledby="tab-download-tab" hidden>
      <div class="field mt-12">
        <section>
          <h3>Download</h3>
          <p>
            Android APK: <a id="latestApkLink" href="https://github.com/konashevich/alien-pass/releases/latest" target="_blank" rel="noopener">Latest release</a>
            <span id="apkHint" class="ghost"></span>
          </p>
        </section>
      </div>
    </section>

    <section id="tab-about" role="tabpanel" aria-labelledby="tab-about-tab" hidden>
      <div class="field mt-12">
        <section>
          <h3>How to use</h3>
          <p>
            Use the Generate tab to create passwords by providing your master password, login, and suffix.
            You can store common logins/suffixes in the Vault and quickly prefill them via the Vault button.
            Backup and restore your Vault entries locally using the buttons in the Vault tab.
          </p>
        </section>
        <section class="mt-12">
          <h3>Author</h3>
          <p>
            © <span id="aboutYear"></span> Oleksii Konashevych.
            Website: <a href="https://oleksii.konashevych.com" target="_blank" rel="noopener">oleksii.konashevych.com</a>
          </p>
        </section>
        <section class="mt-12">
          <h3>Credits</h3>
          <p>
            This app uses xxHash (XXH32) for hashing.
            Project page: <a href="https://github.com/Cyan4973/xxHash" target="_blank" rel="noopener">github.com/Cyan4973/xxHash</a>.
          </p>
          <blockquote class="credit-quote">
            xxHash is an Extremely fast Hash algorithm, running at RAM speed limits.
          </blockquote>
        </section>
        <section class="mt-12">
          <h3>Version</h3>
          <p id="aboutVersion" class="ghost">Loading version…</p>
        </section>
      </div>
    </section>

    <footer>
      <span id="status" aria-live="polite"></span>
    </footer>
  </div>

  <!-- Vault quick-select modal -->
  <div id="vaultModal" class="modal-backdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="vaultModalTitle">
      <header>
        <strong id="vaultModalTitle">Select from Vault</strong>
        <button id="closeVaultModal" class="small" type="button">Close</button>
      </header>
      <div class="content">
        <div class="field">
          <input type="text" id="modalSearch" placeholder="Search...">
        </div>
        <div id="vaultQuickList" class="list"></div>
      </div>
      <div class="actions">
        <button id="manageVaultBtn" class="small" type="button">Open Vault</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit entry modal -->
  <div id="entryModal" class="modal-backdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="entryModalTitle">
      <header>
        <strong id="entryModalTitle">Add Entry</strong>
        <button id="closeEntryModal" class="small" type="button">Close</button>
      </header>
      <div class="content">
        <form id="entryForm" class="field-group">
          <input type="hidden" id="entryId">
          <div class="field">
            <label for="entryName">Name</label>
            <input type="text" id="entryName" required>
          </div>
          <div class="field">
            <label for="entryLogin">Login</label>
            <input type="text" id="entryLogin" autocomplete="username">
          </div>
          <div class="field">
            <label for="entrySuffix">Suffix</label>
            <input type="text" id="entrySuffix" value="+AB">
          </div>
          <div class="field">
            <label>Domains</label>
            <div id="entryDomainsGroup">
              <div id="entryDomainsList" class="field-group"></div>
              <div class="actions left mt-8">
                <button id="addDomainBtn" class="small" type="button">+ Add domain</button>
              </div>
            </div>
          </div>
          <div class="field">
            <label for="entryFavourite" class="checkbox-label"><input type="checkbox" id="entryFavourite"> Favourite</label>
          </div>
          <div class="field">
            <label for="entryNote">Note</label>
            <textarea id="entryNote" rows="3"></textarea>
          </div>
          <div id="entryError" class="error"></div>
        </form>
      </div>
      <div class="actions">
        <button id="saveEntryBtn" class="primary" type="button">Save</button>
      </div>
    </div>
  </div>


  <script src="./xxhash.min.js"></script>
  <script type="text/plain" data-disabled="true">
  // BEGIN: XXH UMD bundle (copied from alienpass.js)
  !function(t,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.XXH=r():t.XXH=r()}(this,function(){return function(t){function r(e){if(i[e])return i[e].exports;var o=i[e]={i:e,l:!1,exports:{}};return t[e].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var i={};return r.m=t,r.c=i,r.d=function(t,i,e){r.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:e})},r.n=function(t){var i=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(i,"a",i),i},r.o=function(t,r){return Object.prototype.hasOwnProperty.call(t,r)},r.p="",r(r.s=2)}([function(t,r,i){"use strict";(function(t){function e(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(r){return!1}}function o(){return n.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function h(t,r){if(o()<r)throw new RangeError("Invalid typed array length");return n.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(r),t.__proto__=n.prototype):(null===t&&(t=new n(r)),t.length=r),t}function n(t,r,i){if(!(n.TYPED_ARRAY_SUPPORT||this instanceof n))return new n(t,r,i);if("number"==typeof t){if("string"==typeof r)throw new Error("If encoding is specified then the first argument must be a string");return f(this,t)}return s(this,t,r,i)}function s(t,r,i,e){if("number"==typeof r)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&r instanceof ArrayBuffer?p(t,r,i,e):"string"==typeof r?l(t,r,i):m(t,r)}function a(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(0>t)throw new RangeError('"size" argument must not be negative')}function u(t,r,i,e){return a(r),0>=r?h(t,r):void 0!==i?"string"==typeof e?h(t,r).fill(i,e):h(t,r).fill(i):h(t,r)}function f(t,r){if(a(r),t=h(t,0>r?0:0|y(r)),!n.TYPED_ARRAY_SUPPORT)for(var i=0;r>i;++i)t[i]=0;return t}function l(t,r,i){if(("string"!=typeof i||""===i)&&(i="utf8"),!n.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var e=0|d(r,i);t=h(t,e);var o=t.write(r,i);return o!==e&&(t=t.slice(0,o)),t}function c(t,r){var i=r.length<0?0:0|y(r.length);t=h(t,i);for(var e=0;i>e;e+=1)t[e]=255&r[e];return t}function p(t,r,i,e){if(r.byteLength,0>i||r.byteLength<i)throw new RangeError("'offset' is out of bounds");if(r.byteLength<i+(e||0))throw new RangeError("'length' is out of bounds");return r=void 0===i&&void 0===e?new Uint8Array(r):void 0===e?new Uint8Array(r,i):new Uint8Array(r,i,e),n.TYPED_ARRAY_SUPPORT?(t=r,t.__proto__=n.prototype):t=c(t,r),t}function m(t,r){if(n.isBuffer(r)){var i=0|y(r.length);return t=h(t,i),0===t.length?t:(r.copy(t,0,0,i),t)}if(r){if("undefined"!=typeof ArrayBuffer&&r.buffer instanceof ArrayBuffer||"length"in r)return"number"!=typeof r.length||K(r.length)?h(t,0):c(t,r);if("Buffer"===r.type&&$(r.data))return c(t,r.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function y(t){if(t>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|t}function _(t){return+t!=t&&(t=0),n.alloc(+t)}function d(t,r){if(n.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var i=t.length;if(0===i)return 0;for(var e=!1;;)switch(r){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return H(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return Z(t).length;default:if(e)return H(t).length;r=(""+r).toLowerCase(),e=!0}}function g(t,r,i){var e=!1;if((void 0===r||0>r)&&(r=0),r>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),0>=i)return"";if(i>>>=0,r>>>=0,r>=i)return"";for(t||(t="utf8");;)switch(t){case"hex":return z(this,r,i);case"utf8":case"utf-8":return P(this,r,i);case"ascii":return S(this,r,i);case"latin1":case"binary":return I(this,r,i);case"base64":return T(this,r,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Y(this,r,i);default:if(e)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),e=!0}}function w(t,r,i){var e=t[r];t[r]=t[i],t[i]=e}function v(t,r,i,e,o){if(0===t.length)return-1;if("string"==typeof i?(e=i,i=0):i>2147483647?i=2147483647:-2147483648>i&&(i=-2147483648),i=+i,isNaN(i)&&(i=o?0:t.length-1),0>i&&(i=t.length+i),i>=t.length){if(o)return-1;i=t.length-1}else if(0>i){if(!o)return-1;i=0}if("string"==typeof r&&(r=n.from(r,e)),n.isBuffer(r))return 0===r.length?-1:A(t,r,i,e,o);if("number"==typeof r)return r=255&r,n.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,r,i):Uint8Array.prototype.lastIndexOf.call(t,r,i):A(t,[r],i,e,o);throw new TypeError("val must be string, number or Buffer")}function A(t,r,i,e,o){function h(t,r){return 1===n?t[r]:t.readUInt16BE(r*n)}var n=1,s=t.length,a=r.length;if(void 0!==e&&(e=String(e).toLowerCase(),"ucs2"===e||"ucs-2"===e||"utf16le"===e||"utf-16le"===e)){if(t.length<2||r.length<2)return-1;n=2,s/=2,a/=2,i/=2}var u;if(o){var f=-1;for(u=i;s>u;u++)if(h(t,u)===h(r,-1===f?0:u-f)){if(-1===f&&(f=u),u-f+1===a)return f*n}else-1!==f&&(u-=u-f),f=-1}else for(i+a>s&&(i=s-a),u=i;u>=0;u--){for(var l=!0,c=0;a>c;c++)if(h(t,u+c)!==h(r,c)){l=!1;break}if(l)return u}return-1}function C(t,r,i,e){i=Number(i)||0;var o=t.length-i;e?(e=Number(e),e>o&&(e=o)):e=o;var h=r.length;if(h%2!==0)throw new TypeError("Invalid hex string");e>h/2&&(e=h/2);for(var n=0;e>n;++n){var s=parseInt(r.substr(2*n,2),16);if(isNaN(s))return n;t[i+n]=s}return n}function b(t,r,i,e){return G(H(r,t.length-i),t,i,e)}function E(t,r,i,e){return G(V(r),t,i,e)}function R(t,r,i,e){return E(t,r,i,e)}function x(t,r,i,e){return G(Z(r),t,i,e)}function B(t,r,i,e){return G(J(r,t.length-i),t,i,e)}function T(t,r,i){return Q.fromByteArray(0===r&&i===t.length?t:t.slice(r,i))}function P(t,r,i){i=Math.min(t.length,i);for(var e=[],o=r;i>o;){var h=t[o],n=null,s=h>239?4:h>223?3:h>191?2:1;if(i>=o+s){var a,u,f,l;switch(s){case 1:128>h&&(n=h);break;case 2:a=t[o+1],128===(192&a)&&(l=(31&h)<<6|63&a,l>127&&(n=l));break;case 3:a=t[o+1],u=t[o+2],128===(192&a)&&128===(192&u)&&(l=(15&h)<<12|(63&a)<<6|63&u,l>2047&&(55296>l||l>57343)&&(n=l));break;case 4:a=t[o+1],u=t[o+2],f=t[o+3],128===(192&a)&&128===(192&u)&&128===(192&f)&&(l=(15&h)<<18|(63&a)<<12|(63&u)<<6|63&f,l>65535&&1114112>l&&(n=l))}}null===n?(n=65533,s=1):n>65535&&(n-=65536,e.push(n>>>10&1023|55296),n=56320|1023&n),e.push(n),o+=s}return U(e)}function U(t){var r=t.length;if(tt>=r)return String.fromCharCode.apply(String,t);for(var i="",e=0;r>e;)i+=String.fromCharCode.apply(String,t.slice(e,e+=tt));return i}function S(t,r,i){var e="";i=Math.min(t.length,i);for(var o=r;i>o;++o)e+=String.fromCharCode(127&t[o]);return e}function I(t,r,i){var e="";i=Math.min(t.length,i);for(var o=r;i>o;++o)e+=String.fromCharCode(t[o]);return e}function z(t,r,i){var e=t.length;(!r||0>r)&&(r=0),(!i||0>i||i>e)&&(i=e);for(var o="",h=r;i>h;++h)o+=X(t[h]);return o}function Y(t,r,i){for(var e=t.slice(r,i),o="",h=0;h<e.length;h+=2)o+=String.fromCharCode(e[h]+256*e[h+1]);return o}function M(t,r,i){if(t%1!==0||0>t)throw new RangeError("offset is not uint");if(t+r>i)throw new RangeError("Trying to access beyond buffer length")}function L(t,r,i,e,o,h){if(!n.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(r>o||h>r)throw new RangeError('"value" argument is out of bounds');if(i+e>t.length)throw new RangeError("Index out of range")}function O(t,r,i,e){0>r&&(r=65535+r+1);for(var o=0,h=Math.min(t.length-i,2);h>o;++o)t[i+o]=(r&255<<8*(e?o:1-o))>>>8*(e?o:1-o)}function N(t,r,i,e){0>r&&(r=4294967295+r+1);for(var o=0,h=Math.min(t.length-i,4);h>o;++o)t[i+o]=r>>>8*(e?o:3-o)&255}function D(t,r,i,e){if(i+e>t.length)throw new RangeError("Index out of range");if(0>i)throw new RangeError("Index out of range")}function k(t,r,i,e,o){return o||D(t,r,i,4,3.4028234663852886e38,-3.4028234663852886e38),W.write(t,r,i,e,23,4),i+4}function j(t,r,i,e,o){return o||D(t,r,i,8,1.7976931348623157e308,-1.7976931348623157e308),W.write(t,r,i,e,52,8),i+8}function F(t){if(t=q(t).replace(rt,""),t.length<2)return"";for(;t.length%4!==0;)t+="=";return t}function q(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function X(t){return 16>t?"0"+t.toString(16):t.toString(16)}function H(t,r){r=r||1/0;for(var i,e=t.length,o=null,h=[],n=0;e>n;++n){if(i=t.charCodeAt(n),i>55295&&57344>i){if(!o){if(i>56319){(r-=3)>-1&&h.push(239,191,189);continue}if(n+1===e){(r-=3)>-1&&h.push(239,191,189);continue}o=i;continue}if(56320>i){(r-=3)>-1&&h.push(239,191,189),o=i;continue}i=(o-55296<<10|i-56320)+65536}else o&&(r-=3)>-1&&h.push(239,191,189);if(o=null,128>i){if((r-=1)<0)break;h.push(i)}else if(2048>i){if((r-=2)<0)break;h.push(i>>6|192,63&i|128)}else if(65536>i){if((r-=3)<0)break;h.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(1114112>i))throw new Error("Invalid code point");if((r-=4)<0)break;h.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return h}function V(t){for(var r=[],i=0;i<t.length;++i)r.push(255&t.charCodeAt(i));return r}function J(t,r){for(var i,e,o,h=[],n=0;n<t.length&&!((r-=2)<0);++n)i=t.charCodeAt(n),e=i>>8,o=i%256,h.push(o),h.push(e);return h}function Z(t){return Q.toByteArray(F(t))}function G(t,r,i,e){for(var o=0;e>o&&!(o+i>=r.length||o>=t.length);++o)r[o+i]=t[o];return o}function K(t){return t!==t}var Q=i(5),W=i(6),$=i(7);r.Buffer=n,r.SlowBuffer=_,r.INSPECT_MAX_BYTES=50,n.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:e(),r.kMaxLength=o(),n.poolSize=8192,n._augment=function(t){return t.__proto__=n.prototype,t},n.from=function(t,r,i){return s(null,t,r,i)},n.TYPED_ARRAY_SUPPORT&&(n.prototype.__proto__=Uint8Array.prototype,n.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&n[Symbol.species]===n&&Object.defineProperty(n,Symbol.species,{value:null,configurable:!0})),n.alloc=function(t,r,i){return u(null,t,r,i)},n.allocUnsafe=function(t){return f(null,t)},n.allocUnsafeSlow=function(t){return f(null,t)},n.isBuffer=function(t){return!(null==t||!t._isBuffer)},n.compare=function(t,r){if(!n.isBuffer(t)||!n.isBuffer(r))throw new TypeError("Arguments must be Buffers");if(t===r)return 0;for(var i=t.length,e=r.length,o=0,h=Math.min(i,e);h>o;++o)if(t[o]!==r[o]){i=t[o],e=r[o];break}return e>i?-1:i>e?1:0},n.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},n.concat=function(t,r){if(!$(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return n.alloc(0);var i;if(void 0===r)for(r=0,i=0;i<t.length;++i)r+=t[i].length;var e=n.allocUnsafe(r),o=0;for(i=0;i<t.length;++i){var h=t[i];if(!n.isBuffer(h))throw new TypeError('"list" argument must be an Array of Buffers');h.copy(e,o),o+=h.length}return e},n.byteLength=d,n.prototype._isBuffer=!0,n.prototype.swap16=function(){var t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var r=0;t>r;r+=2)w(this,r,r+1);return this},n.prototype.swap32=function(){var t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var r=0;t>r;r+=4)w(this,r,r+3),w(this,r+1,r+2);return this},n.prototype.swap64=function(){var t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var r=0;t>r;r+=8)w(this,r,r+7),w(this,r+1,r+6),w(this,r+2,r+5),w(this,r+3,r+4);return this},n.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?P(this,0,t):g.apply(this,arguments)},n.prototype.equals=function(t){if(!n.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:0===n.compare(this,t)},n.prototype.inspect=function(){var t="",i=r.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(t+=" ... ")),"<Buffer "+t+">"},n.prototype.compare=function(t,r,i,e,o){if(!n.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===r&&(r=0),void 0===i&&(i=t?t.length:0),void 0===e&&(e=0),void 0===o&&(o=this.length),0>r||i>t.length||0>e||o>this.length)throw new RangeError("out of range index");if(e>=o&&r>=i)return 0;if(e>=o)return-1;if(r>=i)return 1;if(r>>>=0,i>>>=0,e>>>=0,o>>>=0,this===t)return 0;for(var h=o-e,s=i-r,a=Math.min(h,s),u=this.slice(e,o),f=t.slice(r,i),l=0;a>l;++l)if(u[l]!==f[l]){h=u[l],s=f[l];break}return s>h?-1:h>s?1:0},n.prototype.includes=function(t,r,i){return-1!==this.indexOf(t,r,i)},n.prototype.indexOf=function(t,r,i){return v(this,t,r,i,!0)},n.prototype.lastIndexOf=function(t,r,i){return v(this,t,r,i,!1)},n.prototype.write=function(t,r,i,e){if(void 0===r)e="utf8",i=this.length,r=0;else if(void 0===i&&"string"==typeof r)e=r,i=this.length,r=0;else{if(!isFinite(r))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");r=0|r,isFinite(i)?(i=0|i,void 0===e&&(e="utf8")):(e=i,i=void 0)}var o=this.length-r;if((void 0===i||i>o)&&(i=o),t.length>0&&(0>i||0>r)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");e||(e="utf8");for(var h=!1;;)switch(e){case"hex":return C(this,t,r,i);case"utf8":case"utf-8":return b(this,t,r,i);case"ascii":return E(this,t,r,i);case"latin1":case"binary":return R(this,t,r,i);case"base64":return x(this,t,r,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,t,r,i);default:if(h)throw new TypeError("Unknown encoding: "+e);e=(""+e).toLowerCase(),h=!0}},n.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var tt=4096;n.prototype.slice=function(t,r){var i=this.length;t=~~t,r=void 0===r?i:~~r,0>t?(t+=i,0>t&&(t=0)):t>i&&(t=i),0>r?(r+=i,0>r&&(r=0)):r>i&&(r=i),t>r&&(r=t);var e;if(n.TYPED_ARRAY_SUPPORT)e=this.subarray(t,r),e.__proto__=n.prototype;else{var o=r-t;e=new n(o,void 0);for(var h=0;o>h;++h)e[h]=this[h+t]}return e},n.prototype.readUIntLE=function(t,r,i){t=0|t,r=0|r,i||M(t,r,this.length);for(var e=this[t],o=1,h=0;++h<r&&(o*=256);)e+=this[t+h]*o;return e},n.prototype.readUIntBE=function(t,r,i){t=0|t,r=0|r,i||M(t,r,this.length);for(var e=this[t+--r],o=1;r>0&&(o*=256);)e+=this[t+--r]*o;return e},n.prototype.readUInt8=function(t,r){return r||M(t,1,this.length),this[t]},n.prototype.readUInt16LE=function(t,r){return r||M(t,2,this.length),this[t]|this[t+1]<<8},n.prototype.readUInt16BE=function(t,r){return r||M(t,2,this.length),this[t]<<8|this[t+1]},n.prototype.readUInt32LE=function(t,r){return r||M(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},n.prototype.readUInt32BE=function(t,r){return r||M(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},n.prototype.readIntLE=function(t,r,i){t=0|t,r=0|r,i||M(t,r,this.length);for(var e=this[t],o=1,h=0;++h<r&&(o*=256);)e+=this[t+h]*o;return o*=128,e>=o&&(e-=Math.pow(2,8*r)),e},n.prototype.readIntBE=function(t,r,i){t=0|t,r=0|r,i||M(t,r,this.length);for(var e=r,o=1,h=this[t+--e];e>0&&(o*=256);)h+=this[t+--e]*o;return o*=128,h>=o&&(h-=Math.pow(2,8*r)),h},n.prototype.readInt8=function(t,r){return r||M(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},n.prototype.readInt16LE=function(t,r){r||M(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},n.prototype.readInt16BE=function(t,r){r||M(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},n.prototype.readInt32LE=function(t,r){return r||M(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},n.prototype.readInt32BE=function(t,r){return r||M(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},n.prototype.readFloatLE=function(t,r){return r||M(t,4,this.length),W.read(this,t,!0,23,4)},n.prototype.readFloatBE=function(t,r){return r||M(t,4,this.length),W.read(this,t,!1,23,4)},n.prototype.readDoubleLE=function(t,r){return r||M(t,8,this.length),W.read(this,t,!0,52,8)},n.prototype.readDoubleBE=function(t,r){return r||M(t,8,this.length),W.read(this,t,!1,52,8)},n.prototype.writeUIntLE=function(t,r,i,e){if(t=+t,r=0|r,i=0|i,!e){var o=Math.pow(2,8*i)-1;L(this,t,r,i,o,0)}var h=1,n=0;for(this[r]=255&t;++n<i&&(h*=256);)this[r+n]=t/h&255;return r+i},n.prototype.writeUIntBE=function(t,r,i,e){if(t=+t,r=0|r,i=0|i,!e){var o=Math.pow(2,8*i)-1;L(this,t,r,i,o,0)}var h=i-1,n=1;for(this[r+h]=255&t;--h>=0&&(n*=256);)this[r+h]=t/n&255;return r+i},n.prototype.writeUInt8=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,1,255,0),n.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[r]=255&t,r+1},n.prototype.writeUInt16LE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,2,65535,0),n.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):O(this,t,r,!0),r+2},n.prototype.writeUInt16BE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,2,65535,0),n.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):O(this,t,r,!1),r+2},n.prototype.writeUInt32LE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,4,4294967295,0),n.TYPED_ARRAY_SUPPORT?(this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=255&t):N(this,t,r,!0),r+4},n.prototype.writeUInt32BE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,4,4294967295,0),n.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):N(this,t,r,!1),r+4},n.prototype.writeIntLE=function(t,r,i,e){if(t=+t,r=0|r,!e){var o=Math.pow(2,8*i-1);L(this,t,r,i,o-1,-o)}var h=0,n=1,s=0;for(this[r]=255&t;++h<i&&(n*=256);)0>t&&0===s&&0!==this[r+h-1]&&(s=1),this[r+h]=(t/n>>0)-s&255;return r+i},n.prototype.writeIntBE=function(t,r,i,e){if(t=+t,r=0|r,!e){var o=Math.pow(2,8*i-1);L(this,t,r,i,o-1,-o)}var h=i-1,n=1,s=0;for(this[r+h]=255&t;--h>=0&&(n*=256);)0>t&&0===s&&0!==this[r+h+1]&&(s=1),this[r+h]=(t/n>>0)-s&255;return r+i},n.prototype.writeInt8=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,1,127,-128),n.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),0>t&&(t=255+t+1),this[r]=255&t,r+1},n.prototype.writeInt16LE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,2,32767,-32768),n.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):O(this,t,r,!0),r+2},n.prototype.writeInt16BE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,2,32767,-32768),n.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):O(this,t,r,!1),r+2},n.prototype.writeInt32LE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,4,2147483647,-2147483648),n.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24):N(this,t,r,!0),r+4},n.prototype.writeInt32BE=function(t,r,i){return t=+t,r=0|r,i||L(this,t,r,4,2147483647,-2147483648),0>t&&(t=4294967295+t+1),n.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):N(this,t,r,!1),r+4},n.prototype.writeFloatLE=function(t,r,i){return k(this,t,r,!0,i)},n.prototype.writeFloatBE=function(t,r,i){return k(this,t,r,!1,i)},n.prototype.writeDoubleLE=function(t,r,i){return j(this,t,r,!0,i)},n.prototype.writeDoubleBE=function(t,r,i){return j(this,t,r,!1,i)},n.prototype.copy=function(t,r,i,e){if(i||(i=0),e||0===e||(e=this.length),r>=t.length&&(r=t.length),r||(r=0),e>0&&i>e&&(e=i),e===i)return 0;if(0===t.length||0===this.length)return 0;if(0>r)throw new RangeError("targetStart out of bounds");if(0>i||i>=this.length)throw new RangeError("sourceStart out of bounds");if(0>e)throw new RangeError("sourceEnd out of bounds");e>this.length&&(e=this.length),t.length-r<e-i&&(e=t.length-r+i);var o,h=e-i;if(this===t&&r>i&&e>r)for(o=h-1;o>=0;--o)t[o+r]=this[o+i];else if(1e3>h||!n.TYPED_ARRAY_SUPPORT)for(o=0;h>o;++o)t[o+r]=this[o+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+h),r);return h},n.prototype.fill=function(t,r,i,e){if("string"==typeof t){if("string"==typeof r?(e=r,r=0,i=this.length):"string"==typeof i&&(e=i,i=this.length),1===t.length){var o=t.charCodeAt(0);256>o&&(t=o)}if(void 0!==e&&"string"!=typeof e)throw new TypeError("encoding must be a string");if("string"==typeof e&&!n.isEncoding(e))throw new TypeError("Unknown encoding: "+e)}else"number"==typeof t&&(t=255&t);if(0>r||this.length<r||this.length<i)throw new RangeError("Out of range index");if(r>=i)return this;r>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0);var h;if("number"==typeof t)for(h=r;i>h;++h)this[h]=t;else{var s=n.isBuffer(t)?t:H(new n(t,e).toString()),a=s.length;for(h=0;i-r>h;++h)this[h+r]=s[h%a]}return this};var rt=/[^+\/0-9A-Za-z-_]/g}).call(r,i(4))},function(t,r,i){r.UINT32=i(8),r.UINT64=i(9)},function(t,r,i){t.exports={h32:i(3),h64:i(10)}},function(t,r,i){(function(r){function e(t){for(var r=[],i=0,e=t.length;e>i;i++){var o=t.charCodeAt(i);128>o?r.push(o):2048>o?r.push(192|o>>6,128|63&o):55296>o||o>=57344?r.push(224|o>>12,128|o>>6&63,128|63&o):(i++,o=65536+((1023&o)<<10|1023&t.charCodeAt(i)),r.push(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o))}return new Uint8Array(r)}function o(){return 2==arguments.length?new o(arguments[1]).update(arguments[0]).digest():this instanceof o?void h.call(this,arguments[0]):new o(arguments[0])}function h(t){return this.seed=t instanceof n?t.clone():n(t),this.v1=this.seed.clone().add(s).add(a),this.v2=this.seed.clone().add(a),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(s),this.total_len=0,this.memsize=0,this.memory=null,this}var n=i(1).UINT32;n.prototype.xxh_update=function(t,r){var i,e,o=a._low,h=a._high;e=t*o,i=e>>>16,i+=r*o,i&=65535,i+=t*h;var n=this._low+(65535&e),u=n>>>16;u+=this._high+(65535&i);var f=u<<16|65535&n;f=f<<13|f>>>19,n=65535&f,u=f>>>16,o=s._low,h=s._high,e=n*o,i=e>>>16,i+=u*o,i&=65535,i+=n*h,this._low=65535&e,this._high=65535&i};var s=n("2654435761"),a=n("2246822519"),u=n("3266489917"),f=n("668265263"),l=n("374761393");o.prototype.init=h,o.prototype.update=function(t){var i,o="string"==typeof t;o&&(t=e(t),o=!1,i=!0),"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&(i=!0,t=new Uint8Array(t));var h=0,n=t.length,s=h+n;if(0==n)return this;if(this.total_len+=n,0==this.memsize&&(this.memory=o?"":i?new Uint8Array(16):new r(16)),this.memsize+n<16)return o?this.memory+=t:i?this.memory.set(t.subarray(0,n),this.memsize):t.copy(this.memory,this.memsize,0,n),this.memsize+=n,this;if(this.memsize>0){o?this.memory+=t.slice(0,16-this.memsize):i?this.memory.set(t.subarray(0,16-this.memsize),this.memsize):t.copy(this.memory,this.memsize,0,16-this.memsize);var a=0;o?(this.v1.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v2.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v3.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2)),a+=4,this.v4.xxh_update(this.memory.charCodeAt(a+1)<<8|this.memory.charCodeAt(a),this.memory.charCodeAt(a+3)<<8|this.memory.charCodeAt(a+2))):(this.v1.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v2.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v3.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2]),a+=4,this.v4.xxh_update(this.memory[a+1]<<8|this.memory[a],this.memory[a+3]<<8|this.memory[a+2])),h+=16-this.memsize,this.memsize=0,o&&(this.memory="")}if(s-16>=h){var u=s-16;do o?(this.v1.xxh_update(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2)),h+=4,this.v2.xxh_update(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2)),h+=4,this.v3.xxh_update(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2)),h+=4,this.v4.xxh_update(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2))):(this.v1.xxh_update(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2]),h+=4,this.v2.xxh_update(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2]),h+=4,this.v3.xxh_update(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2]),h+=4,this.v4.xxh_update(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2])),h+=4;while(u>=h)}return s>h&&(o?this.memory+=t.slice(h):i?this.memory.set(t.subarray(h,s),this.memsize):t.copy(this.memory,this.memsize,h,s),this.memsize=s-h),this},o.prototype.digest=function(){var t,r,i=this.memory,e="string"==typeof i,o=0,h=this.memsize,c=new n;for(t=this.total_len>=16?this.v1.rotl(1).add(this.v2.rotl(7).add(this.v3.rotl(12).add(this.v4.rotl(18)))):this.seed.clone().add(l),t.add(c.fromNumber(this.total_len));h-4>=o;)e?c.fromBits(i.charCodeAt(o+1)<<8|i.charCodeAt(o),i.charCodeAt(o+3)<<8|i.charCodeAt(o+2)):c.fromBits(i[o+1]<<8|i[o],i[o+3]<<8|i[o+2]),t.add(c.multiply(u)).rotl(17).multiply(f),o+=4;for(;h>o;)c.fromBits(e?i.charCodeAt(o++):i[o++],0),t.add(c.multiply(l)).rotl(11).multiply(s);return r=t.clone().shiftRight(15),t.xor(r).multiply(a),r=t.clone().shiftRight(13),t.xor(r).multiply(u),r=t.clone().shiftRight(16),t.xor(r),this.init(this.seed),t},t.exports=o}).call(r,i(0).Buffer)},{},function(t,r,i){(function(r){function e(t){for(var r=[],i=0,e=t.length;e>i;i++){var o=t.charCodeAt(i);128>o?r.push(o):2048>o?r.push(192|o>>6,128|63&o):55296>o||o>=57344?r.push(224|o>>12,128|o>>6&63,128|63&o):(i++,o=65536+((1023&o)<<10|1023&t.charCodeAt(i)),r.push(240|o>>18,128|o>>12&63,128|o>>6&63,128|63&o))}return new Uint8Array(r)}function o(){return 2==arguments.length?new o(arguments[1]).update(arguments[0]).digest():this instanceof o?void h.call(this,arguments[0]):new o(arguments[0])}function h(t){return this.seed=t instanceof n?t.clone():n(t),this.v1=this.seed.clone().add(s).add(a),this.v2=this.seed.clone().add(a),this.v3=this.seed.clone(),this.v4=this.seed.clone().subtract(s),this.total_len=0,this.memsize=0,this.memory=null,this}var n=i(1).UINT64,s=n("11400714785074694791"),a=n("14029467366897019727"),u=n("1609587929392839161"),f=n("9650029242287828579"),l=n("2870177450012600261");o.prototype.init=h,o.prototype.update=function(t){var i,o="string"==typeof t;o&&(t=e(t),o=!1,i=!0),"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&(i=!0,t=new Uint8Array(t));var h=0,u=t.length,f=h+u;if(0==u)return this;if(this.total_len+=u,0==this.memsize&&(this.memory=o?"":i?new Uint8Array(32):new r(32)),this.memsize+u<32)return o?this.memory+=t:i?this.memory.set(t.subarray(0,u),this.memsize):t.copy(this.memory,this.memsize,0,u),this.memsize+=u,this;if(this.memsize>0){o?this.memory+=t.slice(0,32-this.memsize):i?this.memory.set(t.subarray(0,32-this.memsize),this.memsize):t.copy(this.memory,this.memsize,0,32-this.memsize);var l=0;if(o){var c;c=n(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v1.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v2.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v3.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory.charCodeAt(l+1)<<8|this.memory.charCodeAt(l),this.memory.charCodeAt(l+3)<<8|this.memory.charCodeAt(l+2),this.memory.charCodeAt(l+5)<<8|this.memory.charCodeAt(l+4),this.memory.charCodeAt(l+7)<<8|this.memory.charCodeAt(l+6)),this.v4.add(c.multiply(a)).rotl(31).multiply(s)}else{var c;c=n(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v1.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v2.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v3.add(c.multiply(a)).rotl(31).multiply(s),l+=8,c=n(this.memory[l+1]<<8|this.memory[l],this.memory[l+3]<<8|this.memory[l+2],this.memory[l+5]<<8|this.memory[l+4],this.memory[l+7]<<8|this.memory[l+6]),this.v4.add(c.multiply(a)).rotl(31).multiply(s)}h+=32-this.memsize,this.memsize=0,o&&(this.memory="")}if(f-32>=h){var p=f-32;do{if(o){var c;c=n(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2),t.charCodeAt(h+5)<<8|t.charCodeAt(h+4),t.charCodeAt(h+7)<<8|t.charCodeAt(h+6)),this.v1.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2),t.charCodeAt(h+5)<<8|t.charCodeAt(h+4),t.charCodeAt(h+7)<<8|t.charCodeAt(h+6)),this.v2.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2),t.charCodeAt(h+5)<<8|t.charCodeAt(h+4),t.charCodeAt(h+7)<<8|t.charCodeAt(h+6)),this.v3.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t.charCodeAt(h+1)<<8|t.charCodeAt(h),t.charCodeAt(h+3)<<8|t.charCodeAt(h+2),t.charCodeAt(h+5)<<8|t.charCodeAt(h+4),t.charCodeAt(h+7)<<8|t.charCodeAt(h+6)),this.v4.add(c.multiply(a)).rotl(31).multiply(s)}else{var c;c=n(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2],t[h+5]<<8|t[h+4],t[h+7]<<8|t[h+6]),this.v1.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2],t[h+5]<<8|t[h+4],t[h+7]<<8|t[h+6]),this.v2.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2],t[h+5]<<8|t[h+4],t[h+7]<<8|t[h+6]),this.v3.add(c.multiply(a)).rotl(31).multiply(s),h+=8,c=n(t[h+1]<<8|t[h],t[h+3]<<8|t[h+2],t[h+5]<<8|t[h+4],t[h+7]<<8|t[h+6]),this.v4.add(c.multiply(a)).rotl(31).multiply(s)}h+=8}while(p>=h)}return f>h&&(o?this.memory+=t.slice(h):i?this.memory.set(t.subarray(h,f),this.memsize):t.copy(this.memory,this.memsize,h,f),this.memsize=f-h),this},o.prototype.digest=function(){var t,r,i=this.memory,e="string"==typeof i,o=0,h=this.memsize,c=new n;for(this.total_len>=32?(t=this.v1.clone().rotl(1),t.add(this.v2.clone().rotl(7)),t.add(this.v3.clone().rotl(12)),t.add(this.v4.clone().rotl(18)),t.xor(this.v1.multiply(a).rotl(31).multiply(s)),t.multiply(s).add(f),t.xor(this.v2.multiply(a).rotl(31).multiply(s)),t.multiply(s).add(f),t.xor(this.v3.multiply(a).rotl(31).multiply(s)),t.multiply(s).add(f),t.xor(this.v4.multiply(a).rotl(31).multiply(s)),t.multiply(s).add(f)):t=this.seed.clone().add(l),t.add(c.fromNumber(this.total_len));h-8>=o;)e?c.fromBits(i.charCodeAt(o+1)<<8|i.charCodeAt(o),i.charCodeAt(o+3)<<8|i.charCodeAt(o+2),i.charCodeAt(o+5)<<8|i.charCodeAt(o+4),i.charCodeAt(o+7)<<8|i.charCodeAt(o+6)):c.fromBits(i[o+1]<<8|i[o],i[o+3]<<8|i[o+2],i[o+5]<<8|i[o+4],i[o+7]<<8|i[o+6]),c.multiply(a).rotl(31).multiply(s),t.xor(c).rotl(27).multiply(s).add(f),o+=8;for(h>=o+4&&(e?c.fromBits(i.charCodeAt(o+1)<<8|i.charCodeAt(o),i.charCodeAt(o+3)<<8|i.charCodeAt(o+2),0,0):c.fromBits(i[o+1]<<8|i[o],i[o+3]<<8|i[o+2],0,0),t.xor(c.multiply(s)).rotl(23).multiply(a).add(u),o+=4);h>o;)c.fromBits(e?i.charCodeAt(o++):i[o++],0,0,0),t.xor(c.multiply(l)).rotl(11).multiply(s);return r=t.clone().shiftRight(33),t.xor(r).multiply(a),r=t.clone().shiftRight(29),t.xor(r).multiply(u),r=t.clone().shiftRight(32),t.xor(r),this.init(this.seed),t},t.exports=o}).call(r,i(0).Buffer)}])});
  // END: XXH UMD bundle
  </script>

  <script>
    (function() {
      // PWA: register service worker in browsers only (skip inside native WebViews)
      const isNativeWebView = typeof window !== 'undefined' && (window.Capacitor || window.cordova || window.ReactNativeWebView);
      if ('serviceWorker' in navigator && !isNativeWebView) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {/* ignore */});
        });
      }
      // ---------------- Tabs ----------------
      const tabs = document.querySelectorAll('.tab');
      const tabPanels = {
        generate: document.getElementById('tab-generate'),
        vault: document.getElementById('tab-vault'),
        settings: document.getElementById('tab-settings'),
        download: document.getElementById('tab-download'),
        about: document.getElementById('tab-about')
      };
      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.tab;
          tabs.forEach(b => b.classList.toggle('active', b === btn));
          Object.entries(tabPanels).forEach(([k, el]) => {
            el.hidden = k !== key;
          });
          if (key === 'generate') {
            reapplyDefaultSuffixIfEmpty();
          }
        });
      });

  const form = document.getElementById('alienPassForm');
      const mpassEl = document.getElementById('mpass');
      const newPasEl = document.getElementById('newPas');
      const confirmEl = document.getElementById('confirmPass');
  const confirmField = document.getElementById('confirmField');
  const saveLoginField = document.getElementById('saveLoginField');
  const saveLoginEl = document.getElementById('saveLogin');
      const loginEl = document.getElementById('login');
      const addedEl = document.getElementById('added');
      const outEl = document.getElementById('out');
      const errorEl = document.getElementById('error');
      const statusEl = document.getElementById('status');
      const generateBtn = document.getElementById('generateBtn');
      const copyBtn = document.getElementById('copyBtn');
      const clearBtn = document.getElementById('clearBtn');
      const openVaultBtn = document.getElementById('openVaultBtn');
  const algorithmEl = document.getElementById('algorithm');

      // Prevent browser password generators/autofill on the Master password field
      // Technique: keep input readonly initially to suppress generators, remove on user interaction
      if (mpassEl) {
        const enableEditing = () => {
          if (mpassEl.hasAttribute('readonly')) mpassEl.removeAttribute('readonly');
        };
        // Remove readonly on genuine user intent
        mpassEl.addEventListener('focus', enableEditing, { once: true });
        mpassEl.addEventListener('mousedown', enableEditing, { once: true });
        mpassEl.addEventListener('touchstart', enableEditing, { once: true });
        // Extra safety: ensure no name hints trigger managers
        mpassEl.setAttribute('autocomplete', 'off');
      }

      // Vault UI elements
      const vaultModal = document.getElementById('vaultModal');
      const closeVaultModal = document.getElementById('closeVaultModal');
      const manageVaultBtn = document.getElementById('manageVaultBtn');
      const vaultQuickList = document.getElementById('vaultQuickList');

      const vaultListFull = document.getElementById('vaultListFull');
      const vaultEmpty = document.getElementById('vaultEmpty');
      const addEntryBtn = document.getElementById('addEntryBtn');
      const backupBtn = document.getElementById('backupBtn');
      const restoreBtn = document.getElementById('restoreBtn');
      const restoreFileInput = document.getElementById('restoreFileInput');

      // Entry modal elements
      const entryModal = document.getElementById('entryModal');
      const entryModalTitle = document.getElementById('entryModalTitle');
      const closeEntryModal = document.getElementById('closeEntryModal');
      const entryForm = document.getElementById('entryForm');
      const entryId = document.getElementById('entryId');
      const entryName = document.getElementById('entryName');
      const entryLogin = document.getElementById('entryLogin');
      const entrySuffix = document.getElementById('entrySuffix');
  const entryDomainsList = document.getElementById('entryDomainsList');
  const addDomainBtn = document.getElementById('addDomainBtn');
      const entryFavourite = document.getElementById('entryFavourite');
      const entryNote = document.getElementById('entryNote');
      const entryError = document.getElementById('entryError');
      const saveEntryBtn = document.getElementById('saveEntryBtn');
  const aboutYear = document.getElementById('aboutYear');

      function padHex8(hex) {
        hex = (hex || '').toLowerCase();
        return ('00000000' + hex).slice(-8);
      }
      function toBase64Url(bytes) {
        let bin = '';
        for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
        return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
      }

      // Algorithms registry and implementations
      const ALG = {
        xxh32: {
          id: 'xxh32',
          label: 'xxHash32',
          compute: (s) => {
            if (typeof XXH === 'undefined' || !XXH.h32) throw new Error('Hash library failed to load. Please refresh the page.');
            const h = XXH.h32(s, 1).toString(16);
            return padHex8(h);
          }
        },
        md5m120: {
          id: 'md5m120',
          label: 'MD5 Modified 120-bit',
          compute: (s) => md5Modified120(s)
        },
        sha256_96: {
          id: 'sha256_96',
          label: 'SHA-256/96',
          compute: async (s) => {
            const enc = new TextEncoder();
            const buf = enc.encode(s);
            const hash = await crypto.subtle.digest('SHA-256', buf);
            const bytes = new Uint8Array(hash).slice(0, 12); // 96 bits
            return toBase64Url(bytes); // 16 chars
          }
        }
      };

      function md5Modified120(input) {
        function RL(lValue, iShiftBits) { return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits)); }
        function AU(lX, lY) {
          const lX8 = (lX & 0x80000000), lY8 = (lY & 0x80000000);
          const lX4 = (lX & 0x40000000), lY4 = (lY & 0x40000000);
          let lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
          if (lX4 & lY4) return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
          if (lX4 | lY4) {
            if (lResult & 0x40000000) return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
            else return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
          }
          return (lResult ^ lX8 ^ lY8);
        }
        function F(x,y,z){ return (x & y) | ((~x) & z); }
        function G(x,y,z){ return (x & z) | (y & (~z)); }
        function H(x,y,z){ return (x ^ y ^ z); }
        function I(x,y,z){ return (y ^ (x | (~z))); }
        function FF(a,b,c,d,x,s,ac){ a = AU(a, AU(AU(F(b,c,d), x), ac)); return AU(RL(a,s), b); }
        function GG(a,b,c,d,x,s,ac){ a = AU(a, AU(AU(G(b,c,d), x), ac)); return AU(RL(a,s), b); }
        function HH(a,b,c,d,x,s,ac){ a = AU(a, AU(AU(H(b,c,d), x), ac)); return AU(RL(a,s), b); }
        function II(a,b,c,d,x,s,ac){ a = AU(a, AU(AU(I(b,c,d), x), ac)); return AU(RL(a,s), b); }
        function toWordArray(str){
          const lMessageLength = str.length;
          const lNumberOfWords_temp1 = lMessageLength + 8;
          const lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
          const lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
          const lWordArray = new Array(lNumberOfWords - 1).fill(0);
          let lBytePosition = 0, lByteCount = 0;
          while (lByteCount < lMessageLength) {
            const lWordCount = (lByteCount - (lByteCount % 4)) / 4;
            lBytePosition = (lByteCount % 4) * 8;
            lWordArray[lWordCount] = (lWordArray[lWordCount] | (str.charCodeAt(lByteCount) << lBytePosition)) >>> 0;
            lByteCount++;
          }
          const lWordCount = (lByteCount - (lByteCount % 4)) / 4;
          lBytePosition = (lByteCount % 4) * 8;
          lWordArray[lWordCount] = (lWordArray[lWordCount] | (0x80 << lBytePosition)) >>> 0;
          lWordArray[lNumberOfWords - 2] = (lMessageLength << 3) >>> 0;
          lWordArray[lNumberOfWords - 1] = (lMessageLength >>> 29) >>> 0;
          return lWordArray;
        }
        function b64Lost2(v) {
          const itoa64 = "A0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzZ";
          v = v & 0x3fffffff;
          let rc = "";
          while (v) { rc += itoa64.charAt(v & 0x3f); v >>>= 6; }
          return rc;
        }
        function utf8(str){
          str = str.replace(/\r\n/g, "\n");
          let utf = "";
          for (let n = 0; n < str.length; n++) {
            const c = str.charCodeAt(n);
            if (c < 128) utf += String.fromCharCode(c);
            else if (c < 2048) { utf += String.fromCharCode((c >> 6) | 192); utf += String.fromCharCode((c & 63) | 128); }
            else { utf += String.fromCharCode((c >> 12) | 224); utf += String.fromCharCode(((c >> 6) & 63) | 128); utf += String.fromCharCode((c & 63) | 128); }
          }
          return utf;
        }
        const S11=7, S12=12, S13=17, S14=22,
              S21=5, S22=9 , S23=14, S24=20,
              S31=4, S32=11, S33=16, S34=23,
              S41=6, S42=10, S43=15, S44=21;
        let a = 0x67452301, b = 0xEFCDAB89, c = 0x98BADCFE, d = 0x10325476;
        const x = toWordArray(utf8(input));
        for (let k = 0; k < x.length; k += 16) {
          const AA=a, BB=b, CC=c, DD=d;
          a=FF(a,b,c,d,x[k+0], S11,0xD76AA478); d=FF(d,a,b,c,x[k+1], S12,0xE8C7B756);
          c=FF(c,d,a,b,x[k+2], S13,0x242070DB); b=FF(b,c,d,a,x[k+3], S14,0xC1BDCEEE);
          a=FF(a,b,c,d,x[k+4], S11,0xF57C0FAF); d=FF(d,a,b,c,x[k+5], S12,0x4787C62A);
          c=FF(c,d,a,b,x[k+6], S13,0xA8304613); b=FF(b,c,d,a,x[k+7], S14,0xFD469501);
          a=FF(a,b,c,d,x[k+8], S11,0x698098D8); d=FF(d,a,b,c,x[k+9], S12,0x8B44F7AF);
          c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1); b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);
          a=FF(a,b,c,d,x[k+12],S11,0x6B901122); d=FF(d,a,b,c,x[k+13],S12,0xFD987193);
          c=FF(c,d,a,b,x[k+14],S13,0xA679438E); b=FF(b,c,d,a,x[k+15],S14,0x49B40821);
          a=GG(a,b,c,d,x[k+1], S21,0xF61E2562); d=GG(d,a,b,c,x[k+6], S22,0xC040B340);
          c=GG(c,d,a,b,x[k+11],S23,0x265E5A51); b=GG(b,c,d,a,x[k+0], S24,0xE9B6C7AA);
          a=GG(a,b,c,d,x[k+5], S21,0xD62F105D); d=GG(d,a,b,c,x[k+10],S22,0x02441453);
          c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681); b=GG(b,c,d,a,x[k+4], S24,0xE7D3FBC8);
          a=GG(a,b,c,d,x[k+9], S21,0x21E1CDE6); d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);
          c=GG(c,d,a,b,x[k+3], S23,0xF4D50D87); b=GG(b,c,d,a,x[k+8], S24,0x455A14ED);
          a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905); d=GG(d,a,b,c,x[k+2], S22,0xFCEFA3F8);
          c=GG(c,d,a,b,x[k+7], S23,0x676F02D9); b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);
          a=HH(a,b,c,d,x[k+5], S31,0xFFFA3942); d=HH(d,a,b,c,x[k+8], S32,0x8771F681);
          c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122); b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);
          a=HH(a,b,c,d,x[k+1], S31,0xA4BEEA44); d=HH(d,a,b,c,x[k+4], S32,0x4BDECFA9);
          c=HH(c,d,a,b,x[k+7], S33,0xF6BB4B60); b=HH(b,c,d,a,x[k+10],S34,0x04881D05);
          a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6); d=HH(d,a,b,c,x[k+0], S32,0xEAA127FA);
          c=HH(c,d,a,b,x[k+3], S33,0xD4EF3085); b=HH(b,c,d,a,x[k+6], S34,0x04881D05);
          a=HH(a,b,c,d,x[k+9], S31,0xD9D4D039); d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);
          c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8); b=HH(b,c,d,a,x[k+2], S34,0xC4AC5665);
          a=II(a,b,c,d,x[k+0], S41,0xF4292244); d=II(d,a,b,c,x[k+7], S42,0x432AFF97);
          c=II(c,d,a,b,x[k+14],S43,0xAB9423A7); b=II(b,c,d,a,x[k+5], S44,0xFC93A039);
          a=II(a,b,c,d,x[k+12],S41,0x655B59C3); d=II(d,a,b,c,x[k+3], S42,0x8F0CCC92);
          c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D); b=II(b,c,d,a,x[k+1], S44,0x85845DD1);
          a=II(a,b,c,d,x[k+8], S41,0x6FA87E4F); d=II(d,a,b,c,x[k+15], S42,0xFE2CE6E0);
          c=II(c,d,a,b,x[k+6], S43,0xA3014314); b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);
          a=AU(a, AA); b=AU(b, BB); c=AU(c, CC); d=AU(d, DD);
        }
        return b64Lost2(a) + b64Lost2(b) + b64Lost2(c) + b64Lost2(d);
      }

      function buildPass0(mpass, login, added) {
        return `|1|${mpass}|2|${login}|3|${added}|4|${mpass}|5|${login}|6|${added}|7|${mpass}|8|${login}|9|${added}|10|`;
      }

      function parseLogin(login) {
        const s = (login || '').trim();
        const at = s.indexOf('@');
        if (at > 0 && at < s.length - 1) {
          return { isEmail: true, name: s.slice(0, at), domain: s.slice(at + 1) };
        }
        return { isEmail: false, name: s, domain: 'default' };
      }

      async function ensureDBAndPut(entry) {
        await ensureDB();
        await putEntry(entry);
      }

      async function generate() {
        errorEl.textContent = '';
        statusEl.textContent = '';
        const mpass = mpassEl.value;
        const login = loginEl.value;
        const added = addedEl.value;
        let pass0 = buildPass0(mpass, login, added);

        if (newPasEl.checked) {
          if (confirmEl.value !== mpass) {
            errorEl.textContent = 'Password and confirm must match.';
            outEl.value = '';
            return;
          }
        }
        // Choose algorithm
        let algId = (algorithmEl && algorithmEl.value) ? algorithmEl.value : await getDefaultAlgorithm();
        if (!ALG[algId]) algId = 'xxh32';
        let digest = '';
        try {
          const maybe = ALG[algId].compute(pass0);
          digest = (maybe && typeof maybe.then === 'function') ? await maybe : maybe;
        } catch (e) {
          errorEl.textContent = e && e.message ? e.message : 'Hashing failed.';
          return;
        }
        outEl.value = (digest || '') + (added || '');
    // Auto-copy the generated result for convenience
    await copyOut();
        // zero sensitive intermediates (best-effort)
        pass0 = '';
        digest = '';
        // Optionally save login to Vault when creating a new password
        try {
          if (newPasEl.checked && saveLoginEl && saveLoginEl.checked) {
            // Safety: never save login if it equals the master password
            if (login && mpass && login === mpass) {
              saveLoginEl.checked = false;
              statusEl.textContent = 'Not saving login that matches the master password.';
            } else {
            const parsed = parseLogin(login);
            const entry = {
              id: genId(),
              name: parsed.name || '(unnamed)',
              login: login || '',
              suffix: added || '+AB',
              domains: parsed.isEmail ? [parsed.domain] : (login ? ['default'] : []),
              favourite: false,
              note: ''
            };
            await ensureDBAndPut(entry);
            await renderVaultLists();
            statusEl.textContent = 'Saved to Vault.';
            }
          }
        } catch (_) {
          // non-fatal
        }
        // Clear sensitive inputs
        mpassEl.value = '';
        confirmEl.value = '';
        loginEl.value = '';
      }

      async function copyOut() {
        const val = outEl.value || '';
        if (!val) { statusEl.textContent = 'Nothing to copy.'; return; }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(val);
            statusEl.textContent = 'Copied to clipboard.';
          } catch (e) {
            fallbackCopy();
          }
        } else {
          fallbackCopy();
        }
      }

      function fallbackCopy() {
        outEl.select();
        try {
          const ok = document.execCommand('copy');
          statusEl.textContent = ok ? 'Copied to clipboard.' : 'Copy failed.';
        } catch (e) {
          statusEl.textContent = 'Copy not supported.';
        }
      }

      // Event wiring
      // New password? toggle: show confirm + save-login controls
      newPasEl.addEventListener('change', () => {
        const on = !!newPasEl.checked;
        confirmEl.disabled = !on;
        confirmField.hidden = !on;
        saveLoginField.hidden = !on;
        if (!on) {
          confirmEl.value = '';
          saveLoginEl.checked = true;
        }
      });

      generateBtn.addEventListener('click', generate);
      copyBtn.addEventListener('click', copyOut);
      clearBtn.addEventListener('click', () => {
        errorEl.textContent = '';
        statusEl.textContent = '';
        confirmEl.disabled = true;
        confirmField.hidden = true;
        saveLoginField.hidden = true;
        outEl.value = '';
        // Re-apply saved default suffix if Added is empty
        setTimeout(() => { try { reapplyDefaultSuffixIfEmpty(); } catch {} }, 0);
      });

      // ---------------- IndexedDB ----------------
  const DB_NAME = 'alienpass';
  const DB_VERSION = 2; // bumped to add settings store
  const STORE = 'vault';
  const STORE_SETTINGS = 'settings';
      let db; // IDBDatabase

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = () => {
            const d = req.result;
            if (!d.objectStoreNames.contains(STORE)) {
              const os = d.createObjectStore(STORE, { keyPath: 'id' });
              os.createIndex('by_name', 'name', { unique: false });
              os.createIndex('by_favourite', 'favourite', { unique: false });
            }
            if (!d.objectStoreNames.contains(STORE_SETTINGS)) {
              d.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
            }
          };
          req.onsuccess = () => { db = req.result; resolve(db); };
          req.onerror = () => reject(req.error);
        });
      }

      function tx(storeName, mode = 'readonly') {
        return db.transaction(storeName, mode).objectStore(storeName);
      }

      function getAllEntries() {
        return new Promise((resolve, reject) => {
          const store = tx(STORE, 'readonly');
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }
      function putEntry(entry) {
        return new Promise((resolve, reject) => {
          const store = tx(STORE, 'readwrite');
          const req = store.put(entry);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }
      function deleteEntry(id) {
        return new Promise((resolve, reject) => {
          const store = tx(STORE, 'readwrite');
          const req = store.delete(id);
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }

      // ---------------- Vault rendering ----------------
      function sortEntries(entries) {
        return entries.slice().sort((a, b) => {
          if (!!b.favourite - !!a.favourite !== 0) return (!!b.favourite - !!a.favourite);
          const an = (a.name || '').toLowerCase();
          const bn = (b.name || '').toLowerCase();
          return an.localeCompare(bn);
        });
      }

      async function renderVaultLists() {
        const all = sortEntries(await getAllEntries());
        const qFull = (document.getElementById('vaultSearch')?.value || '').trim().toLowerCase();
        const qModal = (document.getElementById('modalSearch')?.value || '').trim().toLowerCase();
        const matches = (e, q) => {
          if (!q) return true;
          const hay = [
            e.name || '',
            e.login || '',
            e.suffix || '',
            Array.isArray(e.domains) ? e.domains.join(' ') : '',
            e.note || ''
          ].join(' ').toLowerCase();
          return hay.includes(q);
        };
        const entriesModal = qModal ? all.filter(e => matches(e, qModal)) : all;
        const entriesFull = qFull ? all.filter(e => matches(e, qFull)) : all;
        // Quick list for modal
        vaultQuickList.innerHTML = '';
        if (entriesModal.length === 0) {
          const em = document.createElement('div');
          em.className = 'ghost';
          em.textContent = 'No entries yet.';
          vaultQuickList.appendChild(em);
        } else {
          entriesModal.forEach(e => {
            const item = document.createElement('div');
            item.className = 'list-item';
            const left = document.createElement('div');
            left.innerHTML = `<strong>${escapeHtml(e.name || '(unnamed)')}</strong>`;
            const right = document.createElement('div');
            right.className = 'meta';
            if (e.favourite) {
              const star = document.createElement('span');
              star.className = 'star';
              star.textContent = '★';
              right.appendChild(star);
            }
            item.appendChild(left);
            item.appendChild(right);
            item.addEventListener('click', () => {
              loginEl.value = e.login || '';
              addedEl.value = e.suffix || '+AB';
              closeModal(vaultModal);
            });
            vaultQuickList.appendChild(item);
          });
        }

        // Full list for Vault tab
        vaultListFull.innerHTML = '';
        if (entriesFull.length === 0) {
          vaultEmpty.hidden = false;
        } else {
          vaultEmpty.hidden = true;
          entriesFull.forEach(e => {
            const row = document.createElement('div');
            row.className = 'list-item';
            const title = document.createElement('div');
            title.innerHTML = `<strong>${escapeHtml(e.name || '(unnamed)')}</strong>`;
            const meta = document.createElement('div');
            meta.className = 'meta';
            if (e.favourite) {
              const star = document.createElement('span');
              star.className = 'star';
              star.textContent = '★';
              meta.appendChild(star);
            }
            const suffixTag = document.createElement('span');
            suffixTag.className = 'tag';
            suffixTag.textContent = e.suffix || '+AB';
            meta.appendChild(suffixTag);
            row.appendChild(title);
            row.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'inline-actions';
            const editBtn = document.createElement('button');
            editBtn.className = 'small';
            editBtn.type = 'button';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => openEntryEditor(e));
            const delBtn = document.createElement('button');
            delBtn.className = 'small';
            delBtn.type = 'button';
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', async () => {
              if (confirm(`Delete "${e.name}"?`)) {
                await deleteEntry(e.id);
                await renderVaultLists();
              }
            });
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            row.appendChild(actions);

            vaultListFull.appendChild(row);
          });
        }
      }

      // ---------------- Modals helpers ----------------
      function openModal(el) { el.hidden = false; }
      function closeModal(el) { el.hidden = true; }

      openVaultBtn.addEventListener('click', async () => {
        await ensureDB();
        await renderVaultLists();
        openModal(vaultModal);
      });
      closeVaultModal.addEventListener('click', () => closeModal(vaultModal));
      manageVaultBtn.addEventListener('click', () => {
        closeModal(vaultModal);
        // Switch to Vault tab
        tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === 'vault'));
        tabPanels.generate.hidden = true;
        tabPanels.vault.hidden = false;
      });

      // About tab content
      if (aboutYear) {
        aboutYear.textContent = new Date().getFullYear();
      }

      // Show app/web version in About
      (async function showVersion() {
        try {
          const el = document.getElementById('aboutVersion');
          if (!el) return;
          const res = await fetch('./app-version.json', { cache: 'no-cache' });
          if (res.ok) {
            const v = await res.json();
            const ver = v?.version || '';
            const build = (v?.build !== undefined) ? ` (build ${v.build})` : '';
            if (ver) {
              el.textContent = `Version ${ver}${build}`;
              return;
            }
          }
          // Fallback: use latest GitHub Release tag
          try {
            const gh = await fetch('https://api.github.com/repos/konashevich/alien-pass/releases/latest', { headers: { 'Accept': 'application/vnd.github+json' } });
            if (gh.ok) {
              const info = await gh.json();
              if (info && info.tag_name) {
                el.textContent = `Version ${String(info.tag_name).replace(/^v/, '')}`;
                return;
              }
            }
          } catch {}
          el.textContent = 'Version: not available';
        } catch {
          const el = document.getElementById('aboutVersion');
          if (el) el.textContent = 'Version: not available';
        }
      })();

      // Auto-resolve "Latest APK" link from GitHub Releases (graceful fallback)
      (async function updateLatestApkLink() {
        try {
          const link = document.getElementById('latestApkLink');
          if (!link) return;
          const hint = document.getElementById('apkHint');
          const cacheKey = 'latestApkMeta';
          const cached = (() => { try { return JSON.parse(localStorage.getItem(cacheKey) || 'null'); } catch { return null; } })();
          const now = Date.now();
          if (cached && cached.url && (now - (cached.ts || 0) < 12 * 60 * 60 * 1000)) {
            link.href = cached.url;
            if (hint && cached.tag) hint.textContent = `(${cached.tag})`;
          }

          // Fetch latest release info
          const res = await fetch('https://api.github.com/repos/konashevich/alien-pass/releases/latest', {
            headers: { 'Accept': 'application/vnd.github+json' }
          });
          if (!res.ok) return; // keep fallback
          const data = await res.json();
          const assets = Array.isArray(data.assets) ? data.assets : [];
          // Heuristic: prefer a universal/release apk if present, otherwise first .apk
          let apk = assets.find(a => /\.(apk)$/i.test(a.name) && /universal|release/i.test(a.name))
                 || assets.find(a => /\.(apk)$/i.test(a.name));
          if (apk && apk.browser_download_url) {
            link.href = apk.browser_download_url;
            if (hint && data.tag_name) hint.textContent = `(${data.tag_name})`;
            try {
              localStorage.setItem(cacheKey, JSON.stringify({ url: apk.browser_download_url, tag: data.tag_name || '', ts: Date.now() }));
            } catch {}
          }
        } catch {
          // ignore, link remains the generic latest page
        }
      })();

      // Entry editor
      function getDomainsFromUI() {
        const inputs = entryDomainsList.querySelectorAll('input[type="text"]');
        return Array.from(inputs)
          .map(i => i.value.trim())
          .filter(Boolean);
      }
      function addDomainRow(value = '') {
        const row = document.createElement('div');
        row.className = 'domain-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'example.com';
        input.value = value;
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'small';
        remove.textContent = 'Remove';
        remove.addEventListener('click', () => row.remove());
        row.appendChild(input);
        row.appendChild(remove);
        entryDomainsList.appendChild(row);
      }
      function setDomainsUI(domains) {
        entryDomainsList.innerHTML = '';
        const list = Array.isArray(domains) ? domains : [];
        if (list.length === 0) {
          addDomainRow('');
        } else {
          list.forEach(d => addDomainRow(d));
        }
      }
      function setEntryForm(data) {
        entryId.value = data?.id || '';
        entryName.value = data?.name || '';
        entryLogin.value = data?.login || '';
        entrySuffix.value = data?.suffix || '+AB';
  setDomainsUI(data?.domains || []);
        entryFavourite.checked = !!data?.favourite;
        entryNote.value = data?.note || '';
        entryError.textContent = '';
      }
      function openEntryEditor(data) {
        entryModalTitle.textContent = data ? 'Edit Entry' : 'Add Entry';
        setEntryForm(data || null);
        openModal(entryModal);
      }
      closeEntryModal.addEventListener('click', () => closeModal(entryModal));
      addEntryBtn.addEventListener('click', () => openEntryEditor(null));
      if (addDomainBtn) {
        addDomainBtn.addEventListener('click', () => addDomainRow(''));
      }
      saveEntryBtn.addEventListener('click', async () => {
        entryError.textContent = '';
        const name = entryName.value.trim();
        if (!name) { entryError.textContent = 'Name is required.'; return; }
        const id = entryId.value || genId();
        const entry = {
          id,
          name,
          login: entryLogin.value || '',
          suffix: entrySuffix.value || '+AB',
          domains: getDomainsFromUI(),
          favourite: !!entryFavourite.checked,
          note: entryNote.value || ''
        };
        await ensureDB();
        await putEntry(entry);
        await renderVaultLists();
        closeModal(entryModal);
      });

      // Backup / Restore
      backupBtn.addEventListener('click', async () => {
        await ensureDB();
        const all = await getAllEntries();
        const settings = {
          defaultSuffix: (await getDefaultSuffix()) || '',
          defaultAlgorithm: (await getDefaultAlgorithm()) || 'xxh32'
        };
        const ts = new Date().toISOString().slice(0, 10);
        const filename = `alienpass-backup-${ts}.json`;
        const payload = JSON.stringify({ version: 2, entries: all, settings }, null, 2);
        const blob = new Blob([payload], { type: 'application/json' });

        // 1) Try Web Share API with files (best UX on Android devices)
        try {
          if (typeof navigator !== 'undefined' && navigator.share && navigator.canShare) {
            const file = new File([blob], filename, { type: 'application/json' });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: 'AlienPass backup', text: 'AlienPass Vault backup' });
              statusEl.textContent = 'Backup shared.';
              return;
            }
          }
        } catch (_) { /* fall through to next strategy */ }

        // 2) Fallback: regular download (works reliably in browsers)
        try {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          statusEl.textContent = 'Backup downloaded.';
          return;
        } catch (_) { /* ignore */ }

        // 3) Last resort: copy JSON to clipboard or open data URL
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(payload);
            alert('Backup copied to clipboard. Paste it into a secure note/file and save as ' + filename + '.');
            return;
          }
        } catch (_) { /* ignore */ }
        try {
          const dataUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(payload);
          window.open(dataUrl, '_blank');
        } catch (_) {
          alert('Backup created, but could not be saved automatically.');
        }
      });
      restoreBtn.addEventListener('click', () => restoreFileInput.click());
      restoreFileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data || !Array.isArray(data.entries)) throw new Error('Invalid backup format');
          await ensureDB();
          for (const raw of data.entries) {
            const entry = sanitizeEntry(raw);
            if (!entry.id) entry.id = genId();
            await putEntry(entry);
          }
          if (data.settings && typeof data.settings === 'object') {
            if (typeof data.settings.defaultSuffix === 'string') {
              await setSetting('defaultSuffix', data.settings.defaultSuffix);
            }
            if (typeof data.settings.defaultAlgorithm === 'string') {
              await setSetting('defaultAlgorithm', data.settings.defaultAlgorithm);
            }
          }
          await initSettingsUI();
          await renderVaultLists();
          alert('Restore completed.');
        } catch (err) {
          alert('Restore failed: ' + (err && err.message ? err.message : String(err)));
        } finally {
          restoreFileInput.value = '';
        }
      });

      function sanitizeEntry(e) {
        return {
          id: typeof e.id === 'string' ? e.id : '',
          name: typeof e.name === 'string' ? e.name : '',
          login: typeof e.login === 'string' ? e.login : '',
          suffix: typeof e.suffix === 'string' ? e.suffix : '+AB',
          domains: Array.isArray(e.domains) ? e.domains.filter(x => typeof x === 'string') : [],
          favourite: !!e.favourite,
          note: typeof e.note === 'string' ? e.note : ''
        };
      }

      function genId() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);
      }

      function escapeHtml(s) {
        return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      async function ensureDB() {
        if (!db) await openDB();
      }

      // Settings: store default suffix in IndexedDB
      function getSetting(key) {
        return new Promise((resolve, reject) => {
          try {
            const store = tx('settings', 'readonly');
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result ? req.result.value : null);
            req.onerror = () => reject(req.error);
          } catch (e) { resolve(null); }
        });
      }
      function setSetting(key, value) {
        return new Promise((resolve, reject) => {
          try {
            const store = tx('settings', 'readwrite');
            const req = store.put({ key, value });
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
          } catch (e) { reject(e); }
        });
      }
  async function getDefaultSuffix() { return (await getSetting('defaultSuffix')) || ''; }
  async function getDefaultAlgorithm() { return (await getSetting('defaultAlgorithm')) || 'xxh32'; }
      async function reapplyDefaultSuffixIfEmpty() {
        try {
          const el = document.getElementById('added');
          if (!el) return;
          if ((el.value || '').trim()) return;
          await ensureDB();
          const def = (await getDefaultSuffix()).trim();
          if (def) el.value = def;
        } catch {}
      }
      async function initSettingsUI() {
        try {
          await ensureDB();
          const inp = document.getElementById('defaultSuffix');
          if (inp) inp.value = (await getDefaultSuffix()) || '';
          const algSel = document.getElementById('defaultAlgorithm');
          if (algSel) algSel.value = await getDefaultAlgorithm();
          if (algorithmEl) algorithmEl.value = await getDefaultAlgorithm();
        } catch {}
      }

      // Search handlers
      function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
      const onSearchChange = debounce(() => { renderVaultLists(); }, 100);
      document.getElementById('vaultSearch')?.addEventListener('input', onSearchChange);
      document.getElementById('modalSearch')?.addEventListener('input', onSearchChange);

      // Initialize DB and first render
      openDB().then(async () => {
        try {
          await renderVaultLists();
          await initSettingsUI();
          await reapplyDefaultSuffixIfEmpty();
        } catch {}
      }).catch(() => {/* ignore */});

      const saveSettingsBtnEl = document.getElementById('saveSettingsBtn');
      if (saveSettingsBtnEl) {
        saveSettingsBtnEl.addEventListener('click', async () => {
          try {
            await ensureDB();
            const inp = document.getElementById('defaultSuffix');
            const val = (inp && inp.value ? inp.value : '').trim();
            await setSetting('defaultSuffix', val);
            const algSel = document.getElementById('defaultAlgorithm');
            const alg = (algSel && algSel.value) ? algSel.value : 'xxh32';
            await setSetting('defaultAlgorithm', ALG[alg] ? alg : 'xxh32');
            if (algorithmEl) algorithmEl.value = await getDefaultAlgorithm();
            statusEl.textContent = 'Settings saved.';
            reapplyDefaultSuffixIfEmpty();
          } catch (e) {
            statusEl.textContent = 'Failed to save settings.';
          }
        });
      }
    })();
  </script>
</body>
</html>
